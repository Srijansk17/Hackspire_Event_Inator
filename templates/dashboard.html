<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Murder Mystery Dashboard</title>
  <!-- Link to your existing static CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style_dash.css') }}">
  <!-- Tailwind CSS for modern styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Inter Font for a clean look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Custom styles for the pop-up chatbot */
    body {
        font-family: 'Inter', sans-serif;
        /* Ensure body has relative positioning if not already */
        position: relative;
        /* Added for background canvas */
        overflow: hidden; /* Prevent scrollbars from canvas */
    }

    /* Canvas for the interactive mouse trails */
    #bg-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Place behind all other content */
    }

    #chatbot-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #c91616; /* Blue button */
      color: rgb(0, 0, 0);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000; /* Ensure it's on top */
      transition: all 0.3s ease-in-out;
    }

    #chatbot-toggle:hover {
        background-color: #cb3333;
        transform: scale(1.05);
    }

    #chatbot-container {
      position: fixed;
      bottom: 90px; /* Above the toggle button */
      right: 20px;
      background-color: #562929e4; /* Slightly lighter dark background for the chat box */
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(42, 21, 21, 0.3), 0 4px 6px -2px rgba(41, 22, 22, 0.1);
      width: 100%;
      max-width: 380px; /* Compact width for pop-up */
      height: 500px; /* Fixed height for pop-up */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 999; /* Below toggle, but above other content */
      transform: translateY(100%); /* Start off-screen */
      opacity: 0;
      pointer-events: none; /* Disable interaction when hidden */
      transition: all 0.3s ease-in-out;
    }

    #chatbot-container.open {
        transform: translateY(0); /* Slide into view */
        opacity: 1;
        pointer-events: auto; /* Enable interaction */
    }

    #chatbot-header {
      background-color: #482222c5;
      padding: 0.75rem 1rem;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      color: #a0aec0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #close-chatbot {
      font-size: 1.5rem;
      cursor: pointer;
      color: #000000;
      transition: color 0.2s;
    }
    #close-chatbot:hover {
      color: #e53e3e; /* Red on hover */
    }

    #chatbot-messages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background-color: #1a202c; /* Message background */
    }

    .chat-message {
      max-width: 85%;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      word-wrap: break-word;
      font-size: 0.95rem;
    }

    .chat-message.user {
      background-color: #e14242; /* Blue for user messages */
      align-self: flex-end;
      color: rgb(0, 0, 0);
      border-bottom-right-radius: 0.25rem;
    }

    .chat-message.bot {
      background-color: #6b0909; /* Purple for bot messages */
      align-self: flex-start;
      color: white;
      border-bottom-left-radius: 0.25rem;
    }

    #chatbot-input-area {
      display: flex;
      padding: 0.75rem 1rem;
      background-color: #832d08;
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
    }

    #chatbot-input {
      flex-grow: 1;
      padding: 0.6rem 0.9rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #cbd5e0; /* Light background for input */
      color: #c50000;
      font-size: 0.95rem;
      outline: none;
    }
    #chatbot-input::placeholder {
      color: #718096;
    }

    #send-button {
      margin-left: 0.75rem;
      padding: 0.6rem 1.2rem;
      background-color: #730202;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease-in-out;
    }
    #send-button:hover {
      background-color:  #2b0b5c;
    }
  </style>
</head>
<body class="dashboard">
  <!-- Canvas for the mouse trail background -->
  <canvas id="bg-canvas"></canvas>

  <div class="container">
    
    <!-- Left panel -->
    <div class="left-panel">
      <a href="{{ url_for('backstory_info') }}" class="btn">Backstory</a>
      <a href="{{ url_for('testimony_info') }}" class="btn">Testimony</a>
    </div>

    <!-- Right panel: Box of Clues -->
    <div class="right-panel">
      <h2>Box of Clues</h2>

      <!-- Add new clue -->
      <form method="POST" action="/dashboard" class="clue-form" autocomplete="off">
        <input type="text" name="clue" placeholder="Type your clue..." required autocomplete="off">
        <button type="submit">Add</button>
      </form>

      <!-- List of saved clues -->
      <ul class="clue-list">
        {% for clue in clues %}
        <li>
          {{ clue[1] }}
          <form method="POST" action="/delete_clue/{{ clue[0] }}" style="display:inline;">
            <button class="delete-btn" title="Delete">âœ–</button>
          </form>
        </li>
        {% endfor %}
      </ul>
    </div>

  </div>

  <!-- Chatbot Toggle Button -->
<div id="chatbot-toggle">
  ðŸ’¬
</div>

<!-- Chatbot Container -->
<div id="chatbot-container">
  <div id="chatbot-header">
    Agent 007
    <span id="close-chatbot">âœ–</span>
  </div>
  <div id="chatbot-messages"></div>
  <div id="chatbot-input-area">
    <input type="text" id="chatbot-input" placeholder="Ask something..." />
    <button id="send-button">Send</button>
  </div>
</div>

<script>
  const chatbotToggle = document.getElementById("chatbot-toggle");
  const chatbotContainer = document.getElementById("chatbot-container");
  const closeChatbot = document.getElementById("close-chatbot");
  const chatbotMessages = document.getElementById("chatbot-messages");
  const chatbotInput = document.getElementById("chatbot-input");
  const sendButton = document.getElementById("send-button");

  // Function to display messages in the chat interface
  function displayMessage(text, sender) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('chat-message', sender);
      messageElement.textContent = text;
      chatbotMessages.appendChild(messageElement);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight; // Scroll to the bottom
  }

  // Initial bot message when the chat opens
  window.onload = () => {
    // Only add initial message if chat is opened
    // displayMessage("Hello! I am Agent 007. Type your passcode here.", 'bot');
    
    // Start the mouse trail animation on window load
    animateMouseTrails(); 
  };

  // Function to send message to the Flask backend
  async function sendMessageToBot(message) {
      displayMessage(message, 'user'); // Display user's message immediately

      try {
          const response = await fetch('/message', { // This should match your Flask route
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({ message: message })
          });

          const data = await response.json();
          print("1. ",data)
          print("\n")
          print("2. ", data.success)
          print("\n")
          print("3. ", data.redirect)
          print("\n")
          print("4. ",data.message)
          print("\n")
          if (data.success) {
              if (data.redirect) {
                  // If the server sends a 'redirect' URL, navigate to it
                  window.location.href = data.redirect;
              } else if (data.message) {
                  // Otherwise, display the bot's message
                  displayMessage(data.message, 'bot');
              }
          } else {
              console.error("Bot response indicatecd an error:", data.error);
              displayMessage("An error occurred with the bot response.", 'bot');
          }
      } catch (error) {
          console.error("Error sending message to bot:", error);
          displayMessage("Could not reach the bot. Please try again.", 'bot');
      }
  }

  // Toggle chatbot visibility
  chatbotToggle.onclick = () => {
    chatbotContainer.classList.add('open');
    chatbotToggle.style.display = "none";
    // Add initial bot message when chat is opened
    if (chatbotMessages.children.length === 0) { // Only if no messages yet
        displayMessage("Hello! I am Agent 007. Type your passcode here.", 'bot');
    }
  };

  closeChatbot.onclick = () => {
    chatbotContainer.classList.remove('open');
    chatbotToggle.style.display = "flex"; /* Change to flex for centering content */
  };

  // Event listener for Enter key in the input field
  chatbotInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter" && chatbotInput.value.trim()) {
      const userMsg = chatbotInput.value.trim();
      sendMessageToBot(userMsg);
      chatbotInput.value = "";
    }
  });

  // Event listener for the Send button
  sendButton.addEventListener("click", () => {
    const userMsg = chatbotInput.value.trim();
    if (userMsg) {
      sendMessageToBot(userMsg);
      chatbotInput.value = "";
    }
  });


  /* NEW CODE FOR MOUSE TRAILS BELOW */
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  let mouseX = 0, mouseY = 0;
  let trails = [];

  // Set initial canvas size and handle resizing
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
  });

  // Update mouse coordinates on movement
  document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
  });

  // Trail particle class
  class Trail {
      constructor(x, y) {
          this.x = x;
          this.y = y;
          this.size = 10; // Initial size of the glow particle
          this.alpha = 0.5; // Initial opacity
      }

      // Update particle properties for animation
      update() {
          this.size *= 0.96; // Shrink over time
          this.alpha *= 0.96; // Fade out over time
      }

      // Draw the particle on the canvas
      draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 0, 0, ${this.alpha})`; // Red glow
          ctx.fill();
      }
  }

  // Animation loop for mouse trails
  function animateMouseTrails() {
      // Clear the entire canvas each frame for fresh drawing
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Add a new trail particle at the current mouse position
      trails.push(new Trail(mouseX, mouseY));

      // Update and draw existing trail particles
      for (let i = 0; i < trails.length; i++) {
          trails[i].update();
          trails[i].draw();

          // Remove particles that have faded out to save performance
          if (trails[i].alpha < 0.05) {
              trails.splice(i, 1);
              i--; // Adjust index after removing an element
          }
      }
      requestAnimationFrame(animateMouseTrails); // Request next animation frame
  }

  // NOTE: The `animateMouseTrails` function is now called from `window.onload`
  // alongside any other initializations you have there.
</script>

</body>
</html>
